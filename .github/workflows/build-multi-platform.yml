name: Build Multi-Platform

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - 'Tests/**'
  pull_request:
    branches: [ main, master ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - 'Tests/**'
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    # 额外保护：即使 paths-ignore 失效，也可以通过 commit message 跳过
    if: |
      (github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[ci skip]')) ||
      (github.event_name == 'pull_request' && !contains(github.event.pull_request.title, '[skip ci]') && !contains(github.event.pull_request.title, '[ci skip]')) ||
      github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows-x64
            script: pwsh publish.ps1 -Windows
          - os: ubuntu-latest
            platform: linux-x64
            script: ./publish.sh linux-x64
          - os: macos-latest
            platform: macos-x64
            script: ./publish.sh macos-x64
          - os: macos-latest
            platform: macos-arm64
            script: ./publish.sh macos-arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get version from Git tag
      id: get_version
      shell: bash
      run: |
        latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
        version=${latest_tag#v}
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "Detected version: $version"
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore AsposeMcpServer.csproj
    
    - name: Clean up license files before build (Unix)
      if: runner.os != 'Windows'
      run: |
        # Security: Remove any license files before building to prevent them from being included in artifacts
        if [ -f "Aspose.Total.lic" ]; then
          rm -f "Aspose.Total.lic"
          echo "Removed Aspose.Total.lic for security"
        fi
        # Remove any other license files
        find . -maxdepth 1 -name "*.lic" -type f -delete 2>/dev/null || true
        echo "License files cleaned before build"
      shell: bash
      continue-on-error: true
    
    - name: Clean up license files before build (Windows)
      if: runner.os == 'Windows'
      run: |
        # Security: Remove any license files before building to prevent them from being included in artifacts
        if (Test-Path "Aspose.Total.lic") {
          Remove-Item "Aspose.Total.lic" -Force -ErrorAction SilentlyContinue
          Write-Host "Removed Aspose.Total.lic for security"
        }
        # Remove any other license files
        Get-ChildItem -Path . -Filter "*.lic" -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
        Write-Host "License files cleaned before build"
      shell: pwsh
      continue-on-error: true
    
    - name: Make publish script executable (Unix)
      if: runner.os != 'Windows'
      run: chmod +x publish.sh
    
    - name: Build and publish
      run: ${{ matrix.script }}
      env:
        VERSION: ${{ steps.get_version.outputs.version }}
    
    - name: Clean up license files from build output (Unix)
      if: runner.os != 'Windows'
      run: |
        # Security: Ensure no license files are included in build artifacts
        find "publish/${{ matrix.platform }}" -name "*.lic" -type f -delete 2>/dev/null || true
        echo "License files removed from build output"
      shell: bash
      continue-on-error: true
    
    - name: Clean up license files from build output (Windows)
      if: runner.os == 'Windows'
      run: |
        # Security: Ensure no license files are included in build artifacts
        Get-ChildItem -Path "publish\${{ matrix.platform }}" -Filter "*.lic" -Recurse -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
        Write-Host "License files removed from build output"
      shell: pwsh
      continue-on-error: true
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}
        path: publish/${{ matrix.platform }}/
        retention-days: 1
        # Security: Artifact only used for job-to-job file transfer
        # Release creation completes before artifact expires
    
    - name: Display build info
      run: |
        echo "Platform: ${{ matrix.platform }}"
        echo "OS: ${{ matrix.os }}"
    
    - name: Display build info (Windows)
      if: runner.os == 'Windows'
      run: dir publish\${{ matrix.platform }}
      shell: cmd
    
    - name: Display build info (Unix)
      if: runner.os != 'Windows'
      run: ls -lh publish/${{ matrix.platform }}

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    # Security: Only create releases for pushes to main/master branches, not for PRs
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
      # Minimal permissions required for creating releases
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get latest version tag
      id: get_version
      shell: bash
      run: |
        # 確保獲取最新的 tag（包括遠程）
        git fetch --tags --force
        latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
        echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
        echo "Latest tag: $latest_tag"
    
    - name: Calculate next version
      id: next_version
      shell: bash
      run: |
        latest_tag="${{ steps.get_version.outputs.latest_tag }}"
        # 移除 v 前綴
        version=${latest_tag#v}
        # 分割版本號
        IFS='.' read -r major minor patch <<< "$version"
        # 遞增補丁版本號，直到找到不存在的版本號
        while true; do
          patch=$((patch + 1))
          candidate_version="v${major}.${minor}.${patch}"
          # 檢查 tag 是否已存在
          if ! git rev-parse "$candidate_version" >/dev/null 2>&1; then
            next_version="$candidate_version"
            break
          fi
          echo "Version $candidate_version already exists, trying next..."
        done
        echo "next_version=$next_version" >> $GITHUB_OUTPUT
        echo "Next version: $next_version"
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display structure
      shell: bash
      run: ls -R artifacts
    
    - name: Clean up license files from artifacts
      shell: bash
      run: |
        # Security: Final check to ensure no license files are included in release archives
        find artifacts -name "*.lic" -type f -delete 2>/dev/null || true
        echo "License files removed from artifacts before creating release archives"
      continue-on-error: true
    
    - name: Create ZIP archives
      shell: bash
      run: |
        cd artifacts
        for dir in */; do
          platform=${dir%/}
          zip -r "../aspose-mcp-server-${platform}.zip" "$dir"
        done
        cd ..
        ls -lh *.zip
    
    - name: Create Release with GitHub CLI
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        tag_name="${{ steps.next_version.outputs.next_version }}"
        release_notes=$(cat <<EOF
        Automated build from commit ${{ github.sha }}
        
        Includes binaries for:
        - Windows (x64)
        - Linux (x64)
        - macOS (x64 + ARM64)
        
        **Build Number:** ${{ github.run_number }}
        **Commit:** ${{ github.sha }}
        EOF
        )
        
        # 檢查 tag 和 release 是否已存在
        if git rev-parse "$tag_name" >/dev/null 2>&1; then
          echo "Tag $tag_name already exists"
          if gh release view "$tag_name" >/dev/null 2>&1; then
            echo "Release $tag_name already exists, skipping creation"
            exit 0
          else
            echo "Tag exists but release doesn't, creating release for existing tag"
          fi
        fi
        
        # 使用 GitHub CLI 創建 release（會自動創建 lightweight tag 如果不存在）
        # tag 格式：v1.0.4（符合語義化版本規則，與之前的 tag 格式一致）
        # --target 指定 tag 指向觸發 workflow 的 commit
        gh release create "$tag_name" \
          --title "Release $tag_name" \
          --notes "$release_notes" \
          --target "${{ github.sha }}" \
          aspose-mcp-server-*.zip

